{"version":3,"file":"utils.js","names":["_lodash","require","_numeral","_interopRequireDefault","obj","__esModule","default","numberFormat","value","decimalPoints","decimalDelimiter","thousandsDelimiter","locale","numeral","localeData","savedDelimiters","delimiters","thousands","decimal","formatString","Number","isFinite","result","format","getRowNumber","index","rowsCount","parseInt","wrappedIndex","Math","abs","formatValue","_ref","stringPrefix","stringSuffix","stringDecimal","stringDecChar","stringThouSep","isNumber","toString","formatTooltip","getCounterData","rows","options","visualizationName","length","countRow","counterColName","targetColName","counterLabel","counterValue","rowNumber","showTrend","targetRowNumber","targetValue","delta","trendPositive","counterValueTooltip","tooltipFormat","targetValueTooltip","formatTargetValue","isValueNumber"],"sources":["../../../src/visualizations/counter/utils.ts"],"sourcesContent":["import { isNumber, isFinite, toString } from \"lodash\";\nimport numeral from \"numeral\";\n\n// TODO: allow user to specify number format string instead of delimiters only\n// It will allow to remove this function (move all that weird formatting logic to a migration\n// that will set number format for all existing counter visualization)\nfunction numberFormat(value: any, decimalPoints: any, decimalDelimiter: any, thousandsDelimiter: any) {\n  // Temporarily update locale data (restore defaults after formatting)\n  const locale = numeral.localeData();\n  const savedDelimiters = locale.delimiters;\n\n  // Mimic old behavior - AngularJS `number` filter defaults:\n  // - `,` as thousands delimiter\n  // - `.` as decimal delimiter\n  // - three decimal points\n  locale.delimiters = {\n    thousands: \",\",\n    decimal: \".\",\n  };\n  let formatString = \"0,0.000\";\n  if ((Number.isFinite(decimalPoints) && decimalPoints >= 0) || decimalDelimiter || thousandsDelimiter) {\n    locale.delimiters = {\n      thousands: thousandsDelimiter,\n      decimal: decimalDelimiter || \".\",\n    };\n\n    formatString = \"0,0\";\n    if (decimalPoints > 0) {\n      formatString += \".\";\n      while (decimalPoints > 0) {\n        formatString += \"0\";\n        decimalPoints -= 1;\n      }\n    }\n  }\n  const result = numeral(value).format(formatString);\n\n  locale.delimiters = savedDelimiters;\n  return result;\n}\n\n// 0 - special case, use first record\n// 1..N - 1-based record number from beginning (wraps if greater than dataset size)\n// -1..-N - 1-based record number from end (wraps if greater than dataset size)\nfunction getRowNumber(index: any, rowsCount: any) {\n  index = parseInt(index, 10) || 0;\n  if (index === 0) {\n    return index;\n  }\n  const wrappedIndex = (Math.abs(index) - 1) % rowsCount;\n  return index > 0 ? wrappedIndex : rowsCount - wrappedIndex - 1;\n}\n\nfunction formatValue(value: any, { stringPrefix, stringSuffix, stringDecimal, stringDecChar, stringThouSep }: any) {\n  if (isNumber(value)) {\n    value = numberFormat(value, stringDecimal, stringDecChar, stringThouSep);\n    return toString(stringPrefix) + value + toString(stringSuffix);\n  }\n  return toString(value);\n}\n\nfunction formatTooltip(value: any, formatString: any) {\n  if (isNumber(value)) {\n    return numeral(value).format(formatString);\n  }\n  return toString(value);\n}\n\nexport function getCounterData(rows: any, options: any, visualizationName: any) {\n  const result = {};\n  const rowsCount = rows.length;\n\n  if (rowsCount > 0 || options.countRow) {\n    const counterColName = options.counterColName;\n    const targetColName = options.targetColName;\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterLabel' does not exist on type '{}... Remove this comment to see the full error message\n    result.counterLabel = options.counterLabel || visualizationName;\n\n    if (options.countRow) {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n      result.counterValue = rowsCount;\n    } else if (counterColName) {\n      const rowNumber = getRowNumber(options.rowNumber, rowsCount);\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n      result.counterValue = rows[rowNumber][counterColName];\n    }\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'showTrend' does not exist on type '{}'.\n    result.showTrend = false;\n\n    if (targetColName) {\n      const targetRowNumber = getRowNumber(options.targetRowNumber, rowsCount);\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      result.targetValue = rows[targetRowNumber][targetColName];\n\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n      if (Number.isFinite(result.counterValue) && isFinite(result.targetValue)) {\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n        const delta = result.counterValue - result.targetValue;\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'showTrend' does not exist on type '{}'.\n        result.showTrend = true;\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'trendPositive' does not exist on type '{... Remove this comment to see the full error message\n        result.trendPositive = delta >= 0;\n      }\n    } else {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      result.targetValue = null;\n    }\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValueTooltip' does not exist on t... Remove this comment to see the full error message\n    result.counterValueTooltip = formatTooltip(result.counterValue, options.tooltipFormat);\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValueTooltip' does not exist on ty... Remove this comment to see the full error message\n    result.targetValueTooltip = formatTooltip(result.targetValue, options.tooltipFormat);\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n    result.counterValue = formatValue(result.counterValue, options);\n\n    if (options.formatTargetValue) {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      result.targetValue = formatValue(result.targetValue, options);\n    } else {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      if (isFinite(result.targetValue)) {\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n        result.targetValue = numeral(result.targetValue).format(\"0[.]00[0]\");\n      }\n    }\n  }\n\n  return result;\n}\n\nexport function isValueNumber(rows: any, options: any) {\n  if (options.countRow) {\n    return true; // array length is always a number\n  }\n\n  const rowsCount = rows.length;\n  if (rowsCount > 0) {\n    const rowNumber = getRowNumber(options.rowNumber, rowsCount);\n    const counterColName = options.counterColName;\n    if (counterColName) {\n      return isNumber(rows[rowNumber][counterColName]);\n    }\n  }\n\n  return false;\n}\n"],"mappings":"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"}