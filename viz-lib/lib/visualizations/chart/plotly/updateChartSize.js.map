{"version":3,"file":"updateChartSize.js","names":["find","pick","extend","fixLegendContainer","plotlyElement","legend","querySelector","node","parentNode","tagName","toLowerCase","style","overflow","placeLegendNextToPlot","layout","transformName","prop","orientation","y","x","xanchor","yanchor","placeLegendBelowPlot","layoutHeight","height","bounds","getBoundingClientRect","Math","floor","max","bottom","top","placeLegendAuto","width","updateChartSize","options","offsetWidth","offsetHeight","_ref","__previousSize","_ref2","_slicedToArray","previousWidth","previousHeight","enabled","placement"],"sources":["../../../../src/visualizations/chart/plotly/updateChartSize.ts"],"sourcesContent":["import { find, pick, extend } from \"lodash\";\n\nfunction fixLegendContainer(plotlyElement: any) {\n  const legend = plotlyElement.querySelector(\".legend\");\n  if (legend) {\n    let node = legend.parentNode;\n    while (node) {\n      if (node.tagName.toLowerCase() === \"svg\") {\n        node.style.overflow = \"visible\";\n        break;\n      }\n      node = node.parentNode;\n    }\n  }\n}\n\nfunction placeLegendNextToPlot(plotlyElement: any, layout: any) {\n  const transformName = find(\n    [\"transform\", \"WebkitTransform\", \"MozTransform\", \"MsTransform\", \"OTransform\"],\n    prop => prop in plotlyElement.style\n  );\n\n  layout.legend = extend({}, layout.legend, {\n    orientation: \"v\",\n    // vertical legend will be rendered properly, so just place it to the right\n    // side of plot\n    y: 1,\n    x: 1,\n    xanchor: \"left\",\n    yanchor: \"top\",\n  });\n\n  const legend = plotlyElement.querySelector(\".legend\");\n  if (legend) {\n    // @ts-expect-error ts-migrate(2538) FIXME: Type 'undefined' cannot be used as an index type.\n    legend.style[transformName] = null;\n  }\n\n  return [pick(layout, [\"width\", \"height\", \"legend\"]), null]; // no further updates\n}\n\nfunction placeLegendBelowPlot(plotlyElement: any, layout: any) {\n  const transformName = find(\n    [\"transform\", \"WebkitTransform\", \"MozTransform\", \"MsTransform\", \"OTransform\"],\n    prop => prop in plotlyElement.style\n  );\n\n  // Save current `layout.height` value because `Plotly.relayout().then(...)` handler may be called multiple\n  // times within single update, and since the handler mutates `layout` object - it may lead to bugs\n  const layoutHeight = layout.height;\n\n  // change legend orientation to horizontal; plotly has a bug with this\n  // legend alignment - it does not preserve enough space under the plot;\n  // so we'll hack this: update plot (it will re-render legend), compute\n  // legend height, reduce plot size by legend height (but not less than\n  // half of plot container's height - legend will have max height equal to\n  // plot height), re-render plot again and offset legend to the space under\n  // the plot.\n  // Related issue: https://github.com/plotly/plotly.js/issues/1199\n  layout.legend = extend({}, layout.legend, {\n    orientation: \"h\",\n    // locate legend inside of plot area - otherwise plotly will preserve\n    // some amount of space under the plot; also this will limit legend height\n    // to plot's height\n    y: 0,\n    x: 0,\n    xanchor: \"left\",\n    yanchor: \"bottom\",\n  });\n\n  // set `overflow: visible` to svg containing legend because later we will\n  // position legend outside of it\n  fixLegendContainer(plotlyElement);\n\n  return [\n    pick(layout, [\"width\", \"height\", \"legend\"]),\n    () => {\n      const legend = plotlyElement.querySelector(\".legend\"); // eslint-disable-line no-shadow\n      if (legend) {\n        // compute real height of legend - items may be split into few columnns,\n        // also scrollbar may be shown\n        const bounds = legend.getBoundingClientRect();\n\n        // here we have two values:\n        // 1. height of plot container excluding height of legend items;\n        //    it may be any value between 0 and plot container's height;\n        // 2. half of plot containers height. Legend cannot be larger than\n        //    plot; if legend is too large, plotly will reduce it's height and\n        //    show a scrollbar; in this case, height of plot === height of legend,\n        //    so we can split container's height half by half between them.\n        layout.height = Math.floor(Math.max(layoutHeight / 2, layoutHeight - (bounds.bottom - bounds.top)));\n        // offset the legend\n        // @ts-expect-error ts-migrate(2538) FIXME: Type 'undefined' cannot be used as an index type.\n        legend.style[transformName] = \"translate(0, \" + layout.height + \"px)\";\n        return [pick(layout, [\"height\"]), null]; // no further updates\n      }\n    },\n  ];\n}\n\nfunction placeLegendAuto(plotlyElement: any, layout: any) {\n  if (layout.width <= 600) {\n    return placeLegendBelowPlot(plotlyElement, layout);\n  } else {\n    return placeLegendNextToPlot(plotlyElement, layout);\n  }\n}\n\nexport default function updateChartSize(plotlyElement: any, layout: any, options: any) {\n  // update layout size to plot container\n  // plot size should be at least 5x5px\n  layout.width = Math.max(5, Math.floor(plotlyElement.offsetWidth));\n  layout.height = Math.max(5, Math.floor(plotlyElement.offsetHeight));\n\n  const [previousWidth, previousHeight] = plotlyElement.__previousSize || [];\n\n  if (layout.width === previousWidth && layout.height === previousHeight) {\n    return;\n  }\n\n  plotlyElement.__previousSize = [layout.width, layout.height];\n\n  if (options.legend.enabled) {\n    switch (options.legend.placement) {\n      case \"auto\":\n        return placeLegendAuto(plotlyElement, layout);\n        break;\n      case \"below\":\n        return placeLegendBelowPlot(plotlyElement, layout);\n        break;\n      // no default\n    }\n  } else {\n    return [pick(layout, [\"width\", \"height\"]), null]; // no further updates\n  }\n}\n"],"mappings":"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"}