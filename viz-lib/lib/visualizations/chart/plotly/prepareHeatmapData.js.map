{"version":3,"file":"prepareHeatmapData.js","names":["map","max","uniq","sortBy","flatten","find","findIndex","createNumberFormatter","Colorscale","d3","chooseTextColorForBackground","defaultColorScheme","getColor","value","scheme","length","upperboundIndex","range","scale","interpolate","prepareSeries","series","options","additionalOptions","colorScheme","formatNumber","plotlySeries","x","y","z","type","name","colorscale","data","v","sortX","sortY","reverseX","reverse","reverseY","zMax","d","zVal","dataLabels","mode","hoverinfo","showlegend","text","textfont","color","i","item","j","datum","zValue","push","isFinite","showDataLabels","bgcolor","fgcolor","prepareHeatmapData","seriesList","heatMinColor","heatMaxColor","getScale","numberFormat"],"sources":["../../../../src/visualizations/chart/plotly/prepareHeatmapData.ts"],"sourcesContent":["import { map, max, uniq, sortBy, flatten, find, findIndex } from \"lodash\";\nimport { createNumberFormatter } from \"@/lib/value-format\";\n// @ts-expect-error ts-migrate(7016) FIXME: Could not find a declaration file for module 'plot... Remove this comment to see the full error message\nimport Colorscale from \"plotly.js/src/components/colorscale\";\nimport * as d3 from \"d3\";\nimport chooseTextColorForBackground from \"@/lib/chooseTextColorForBackground\";\n\nconst defaultColorScheme = [\n  [0, \"#356aff\"],\n  [0.14, \"#4a7aff\"],\n  [0.28, \"#5d87ff\"],\n  [0.42, \"#7398ff\"],\n  [0.56, \"#fb8c8c\"],\n  [0.71, \"#ec6463\"],\n  [0.86, \"#ec4949\"],\n  [1, \"#e92827\"],\n];\n\nfunction getColor(value: any, scheme: any) {\n  if (value == 1) { return scheme[scheme.length - 1][1]; }\n  const upperboundIndex = findIndex(scheme, (range: any) => value < range[0]);\n  const scale = d3.interpolate(scheme[upperboundIndex - 1][1], scheme[upperboundIndex][1]);\n  return scale(value);\n}\n\nfunction prepareSeries(series: any, options: any, additionalOptions: any) {\n  const { colorScheme, formatNumber } = additionalOptions;\n\n  const plotlySeries = {\n    x: [],\n    y: [],\n    z: [],\n    type: \"heatmap\",\n    name: \"\",\n    colorscale: colorScheme,\n  };\n\n  // @ts-expect-error ts-migrate(2322) FIXME: Type 'any[]' is not assignable to type 'never[]'.\n  plotlySeries.x = uniq(map(series.data, v => v.x));\n  // @ts-expect-error ts-migrate(2322) FIXME: Type 'any[]' is not assignable to type 'never[]'.\n  plotlySeries.y = uniq(map(series.data, v => v.y));\n\n  if (options.sortX) {\n    plotlySeries.x = sortBy(plotlySeries.x);\n  }\n\n  if (options.sortY) {\n    plotlySeries.y = sortBy(plotlySeries.y);\n  }\n\n  if (options.reverseX) {\n    plotlySeries.x.reverse();\n  }\n\n  if (options.reverseY) {\n    plotlySeries.y.reverse();\n  }\n\n  const zMax = max(map(series.data, d => d.zVal));\n\n  // Use text trace instead of default annotation for better performance\n  const dataLabels = {\n    x: [],\n    y: [],\n    mode: \"text\",\n    hoverinfo: \"skip\",\n    showlegend: false,\n    text: [],\n    textfont: {\n      color: [],\n    },\n  };\n\n  for (let i = 0; i < plotlySeries.y.length; i += 1) {\n    const item = [];\n    for (let j = 0; j < plotlySeries.x.length; j += 1) {\n      const datum = find(series.data, { x: plotlySeries.x[j], y: plotlySeries.y[i] });\n\n      const zValue = (datum && datum.zVal) || 0;\n      item.push(zValue);\n\n      if (isFinite(zMax) && options.showDataLabels) {\n        dataLabels.x.push(plotlySeries.x[j]);\n        dataLabels.y.push(plotlySeries.y[i]);\n        // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'any' is not assignable to parame... Remove this comment to see the full error message\n        dataLabels.text.push(formatNumber(zValue));\n        if (options.colorScheme) {\n          const bgcolor = getColor(zValue / zMax, colorScheme);\n          const fgcolor = chooseTextColorForBackground(bgcolor);\n          // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'string' is not assignable to par... Remove this comment to see the full error message\n          dataLabels.textfont.color.push(fgcolor);\n        }\n      }\n    }\n    // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'any[]' is not assignable to para... Remove this comment to see the full error message\n    plotlySeries.z.push(item);\n  }\n\n  if (isFinite(zMax) && options.showDataLabels) {\n    return [plotlySeries, dataLabels];\n  }\n  return [plotlySeries];\n}\n\nexport default function prepareHeatmapData(seriesList: any, options: any) {\n  let colorScheme = [];\n\n  if (!options.colorScheme) {\n    colorScheme = defaultColorScheme;\n  } else if (options.colorScheme === \"Custom...\") {\n    colorScheme = [\n      [0, options.heatMinColor],\n      [1, options.heatMaxColor],\n    ];\n  } else {\n    colorScheme = Colorscale.getScale(options.colorScheme);\n  }\n\n  const additionalOptions = {\n    colorScheme,\n    formatNumber: createNumberFormatter(options.numberFormat),\n  };\n\n  return flatten(map(seriesList, series => prepareSeries(series, options, additionalOptions)));\n}\n"],"mappings":"AAAA,SAASA,GAAG,EAAEC,GAAG,EAAEC,IAAI,EAAEC,MAAM,EAAEC,OAAO,EAAEC,IAAI,EAAEC,SAAS,QAAQ,QAAQ;AACzE,SAASC,qBAAqB;AAC9B;AACA,OAAOC,UAAU,MAAM,qCAAqC;AAC5D,OAAO,KAAKC,EAAE,MAAM,IAAI;AACxB,OAAOC,4BAA4B;AAEnC,IAAMC,kBAAkB,GAAG,CACzB,CAAC,CAAC,EAAE,SAAS,CAAC,EACd,CAAC,IAAI,EAAE,SAAS,CAAC,EACjB,CAAC,IAAI,EAAE,SAAS,CAAC,EACjB,CAAC,IAAI,EAAE,SAAS,CAAC,EACjB,CAAC,IAAI,EAAE,SAAS,CAAC,EACjB,CAAC,IAAI,EAAE,SAAS,CAAC,EACjB,CAAC,IAAI,EAAE,SAAS,CAAC,EACjB,CAAC,CAAC,EAAE,SAAS,CAAC,CACf;AAED,SAASC,QAAQA,CAACC,KAAU,EAAEC,MAAW,EAAE;EACzC,IAAID,KAAK,IAAI,CAAC,EAAE;IAAE,OAAOC,MAAM,CAACA,MAAM,CAACC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;EAAE;EACvD,IAAMC,eAAe,GAAGV,SAAS,CAACQ,MAAM,EAAGG,KAAU,IAAKJ,KAAK,GAAGI,KAAK,CAAC,CAAC,CAAC,CAAC;EAC3E,IAAMC,KAAK,GAAGT,EAAE,CAACU,WAAW,CAACL,MAAM,CAACE,eAAe,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,EAAEF,MAAM,CAACE,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;EACxF,OAAOE,KAAK,CAACL,KAAK,CAAC;AACrB;AAEA,SAASO,aAAaA,CAACC,MAAW,EAAEC,OAAY,EAAEC,iBAAsB,EAAE;EACxE,IAAQC,WAAW,GAAmBD,iBAAiB,CAA/CC,WAAW;IAAEC,YAAY,GAAKF,iBAAiB,CAAlCE,YAAY;EAEjC,IAAMC,YAAY,GAAG;IACnBC,CAAC,EAAE,EAAE;IACLC,CAAC,EAAE,EAAE;IACLC,CAAC,EAAE,EAAE;IACLC,IAAI,EAAE,SAAS;IACfC,IAAI,EAAE,EAAE;IACRC,UAAU,EAAER;EACd,CAAC;;EAED;EACAE,YAAY,CAACC,CAAC,GAAGzB,IAAI,CAACF,GAAG,CAACqB,MAAM,CAACY,IAAI,EAAEC,CAAC,IAAIA,CAAC,CAACP,CAAC,CAAC,CAAC;EACjD;EACAD,YAAY,CAACE,CAAC,GAAG1B,IAAI,CAACF,GAAG,CAACqB,MAAM,CAACY,IAAI,EAAEC,CAAC,IAAIA,CAAC,CAACN,CAAC,CAAC,CAAC;EAEjD,IAAIN,OAAO,CAACa,KAAK,EAAE;IACjBT,YAAY,CAACC,CAAC,GAAGxB,MAAM,CAACuB,YAAY,CAACC,CAAC,CAAC;EACzC;EAEA,IAAIL,OAAO,CAACc,KAAK,EAAE;IACjBV,YAAY,CAACE,CAAC,GAAGzB,MAAM,CAACuB,YAAY,CAACE,CAAC,CAAC;EACzC;EAEA,IAAIN,OAAO,CAACe,QAAQ,EAAE;IACpBX,YAAY,CAACC,CAAC,CAACW,OAAO,CAAC,CAAC;EAC1B;EAEA,IAAIhB,OAAO,CAACiB,QAAQ,EAAE;IACpBb,YAAY,CAACE,CAAC,CAACU,OAAO,CAAC,CAAC;EAC1B;EAEA,IAAME,IAAI,GAAGvC,GAAG,CAACD,GAAG,CAACqB,MAAM,CAACY,IAAI,EAAEQ,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAAC;;EAE/C;EACA,IAAMC,UAAU,GAAG;IACjBhB,CAAC,EAAE,EAAE;IACLC,CAAC,EAAE,EAAE;IACLgB,IAAI,EAAE,MAAM;IACZC,SAAS,EAAE,MAAM;IACjBC,UAAU,EAAE,KAAK;IACjBC,IAAI,EAAE,EAAE;IACRC,QAAQ,EAAE;MACRC,KAAK,EAAE;IACT;EACF,CAAC;EAED,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGxB,YAAY,CAACE,CAAC,CAACb,MAAM,EAAEmC,CAAC,IAAI,CAAC,EAAE;IACjD,IAAMC,IAAI,GAAG,EAAE;IACf,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG1B,YAAY,CAACC,CAAC,CAACZ,MAAM,EAAEqC,CAAC,IAAI,CAAC,EAAE;MACjD,IAAMC,KAAK,GAAGhD,IAAI,CAACgB,MAAM,CAACY,IAAI,EAAE;QAAEN,CAAC,EAAED,YAAY,CAACC,CAAC,CAACyB,CAAC,CAAC;QAAExB,CAAC,EAAEF,YAAY,CAACE,CAAC,CAACsB,CAAC;MAAE,CAAC,CAAC;MAE/E,IAAMI,MAAM,GAAID,KAAK,IAAIA,KAAK,CAACX,IAAI,IAAK,CAAC;MACzCS,IAAI,CAACI,IAAI,CAACD,MAAM,CAAC;MAEjB,IAAIE,QAAQ,CAAChB,IAAI,CAAC,IAAIlB,OAAO,CAACmC,cAAc,EAAE;QAC5Cd,UAAU,CAAChB,CAAC,CAAC4B,IAAI,CAAC7B,YAAY,CAACC,CAAC,CAACyB,CAAC,CAAC,CAAC;QACpCT,UAAU,CAACf,CAAC,CAAC2B,IAAI,CAAC7B,YAAY,CAACE,CAAC,CAACsB,CAAC,CAAC,CAAC;QACpC;QACAP,UAAU,CAACI,IAAI,CAACQ,IAAI,CAAC9B,YAAY,CAAC6B,MAAM,CAAC,CAAC;QAC1C,IAAIhC,OAAO,CAACE,WAAW,EAAE;UACvB,IAAMkC,OAAO,GAAG9C,QAAQ,CAAC0C,MAAM,GAAGd,IAAI,EAAEhB,WAAW,CAAC;UACpD,IAAMmC,OAAO,GAAGjD,4BAA4B,CAACgD,OAAO,CAAC;UACrD;UACAf,UAAU,CAACK,QAAQ,CAACC,KAAK,CAACM,IAAI,CAACI,OAAO,CAAC;QACzC;MACF;IACF;IACA;IACAjC,YAAY,CAACG,CAAC,CAAC0B,IAAI,CAACJ,IAAI,CAAC;EAC3B;EAEA,IAAIK,QAAQ,CAAChB,IAAI,CAAC,IAAIlB,OAAO,CAACmC,cAAc,EAAE;IAC5C,OAAO,CAAC/B,YAAY,EAAEiB,UAAU,CAAC;EACnC;EACA,OAAO,CAACjB,YAAY,CAAC;AACvB;AAEA,eAAe,SAASkC,kBAAkBA,CAACC,UAAe,EAAEvC,OAAY,EAAE;EACxE,IAAIE,WAAW,GAAG,EAAE;EAEpB,IAAI,CAACF,OAAO,CAACE,WAAW,EAAE;IACxBA,WAAW,GAAGb,kBAAkB;EAClC,CAAC,MAAM,IAAIW,OAAO,CAACE,WAAW,KAAK,WAAW,EAAE;IAC9CA,WAAW,GAAG,CACZ,CAAC,CAAC,EAAEF,OAAO,CAACwC,YAAY,CAAC,EACzB,CAAC,CAAC,EAAExC,OAAO,CAACyC,YAAY,CAAC,CAC1B;EACH,CAAC,MAAM;IACLvC,WAAW,GAAGhB,UAAU,CAACwD,QAAQ,CAAC1C,OAAO,CAACE,WAAW,CAAC;EACxD;EAEA,IAAMD,iBAAiB,GAAG;IACxBC,WAAW;IACXC,YAAY,EAAElB,qBAAqB,CAACe,OAAO,CAAC2C,YAAY;EAC1D,CAAC;EAED,OAAO7D,OAAO,CAACJ,GAAG,CAAC6D,UAAU,EAAExC,MAAM,IAAID,aAAa,CAACC,MAAM,EAAEC,OAAO,EAAEC,iBAAiB,CAAC,CAAC,CAAC;AAC9F"}