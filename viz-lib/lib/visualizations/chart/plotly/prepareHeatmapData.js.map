{"version":3,"file":"prepareHeatmapData.js","names":["_lodash","require","_valueFormat","_colorscale","_interopRequireDefault","_d","_chooseTextColorForBackground","obj","__esModule","default","defaultColorScheme","getColor","value","scheme","length","upperboundIndex","findIndex","range","scale","d3","interpolate","prepareSeries","series","options","additionalOptions","colorScheme","formatNumber","plotlySeries","x","y","z","type","name","colorscale","uniq","map","data","v","sortX","sortBy","sortY","reverseX","reverse","reverseY","zMax","max","d","zVal","dataLabels","mode","hoverinfo","showlegend","text","textfont","color","i","item","j","datum","find","zValue","push","isFinite","showDataLabels","bgcolor","fgcolor","chooseTextColorForBackground","prepareHeatmapData","seriesList","heatMinColor","heatMaxColor","Colorscale","getScale","createNumberFormatter","numberFormat","flatten"],"sources":["../../../../src/visualizations/chart/plotly/prepareHeatmapData.ts"],"sourcesContent":["import { map, max, uniq, sortBy, flatten, find, findIndex } from \"lodash\";\nimport { createNumberFormatter } from \"@/lib/value-format\";\n// @ts-expect-error ts-migrate(7016) FIXME: Could not find a declaration file for module 'plot... Remove this comment to see the full error message\nimport Colorscale from \"plotly.js/src/components/colorscale\";\nimport d3 from \"d3\";\nimport chooseTextColorForBackground from \"@/lib/chooseTextColorForBackground\";\n\nconst defaultColorScheme = [\n  [0, \"#356aff\"],\n  [0.14, \"#4a7aff\"],\n  [0.28, \"#5d87ff\"],\n  [0.42, \"#7398ff\"],\n  [0.56, \"#fb8c8c\"],\n  [0.71, \"#ec6463\"],\n  [0.86, \"#ec4949\"],\n  [1, \"#e92827\"],\n];\n\nfunction getColor(value: any, scheme: any) {\n  if (value == 1) { return scheme[scheme.length - 1][1]; }\n  const upperboundIndex = findIndex(scheme, (range: any) => value < range[0]);\n  const scale = d3.interpolate(scheme[upperboundIndex - 1][1], scheme[upperboundIndex][1]);\n  return scale(value);\n}\n\nfunction prepareSeries(series: any, options: any, additionalOptions: any) {\n  const { colorScheme, formatNumber } = additionalOptions;\n\n  const plotlySeries = {\n    x: [],\n    y: [],\n    z: [],\n    type: \"heatmap\",\n    name: \"\",\n    colorscale: colorScheme,\n  };\n\n  // @ts-expect-error ts-migrate(2322) FIXME: Type 'any[]' is not assignable to type 'never[]'.\n  plotlySeries.x = uniq(map(series.data, v => v.x));\n  // @ts-expect-error ts-migrate(2322) FIXME: Type 'any[]' is not assignable to type 'never[]'.\n  plotlySeries.y = uniq(map(series.data, v => v.y));\n\n  if (options.sortX) {\n    plotlySeries.x = sortBy(plotlySeries.x);\n  }\n\n  if (options.sortY) {\n    plotlySeries.y = sortBy(plotlySeries.y);\n  }\n\n  if (options.reverseX) {\n    plotlySeries.x.reverse();\n  }\n\n  if (options.reverseY) {\n    plotlySeries.y.reverse();\n  }\n\n  const zMax = max(map(series.data, d => d.zVal));\n\n  // Use text trace instead of default annotation for better performance\n  const dataLabels = {\n    x: [],\n    y: [],\n    mode: \"text\",\n    hoverinfo: \"skip\",\n    showlegend: false,\n    text: [],\n    textfont: {\n      color: [],\n    },\n  };\n\n  for (let i = 0; i < plotlySeries.y.length; i += 1) {\n    const item = [];\n    for (let j = 0; j < plotlySeries.x.length; j += 1) {\n      const datum = find(series.data, { x: plotlySeries.x[j], y: plotlySeries.y[i] });\n\n      const zValue = (datum && datum.zVal) || 0;\n      item.push(zValue);\n\n      if (isFinite(zMax) && options.showDataLabels) {\n        dataLabels.x.push(plotlySeries.x[j]);\n        dataLabels.y.push(plotlySeries.y[i]);\n        // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'any' is not assignable to parame... Remove this comment to see the full error message\n        dataLabels.text.push(formatNumber(zValue));\n        if (options.colorScheme) {\n          const bgcolor = getColor(zValue / zMax, colorScheme);\n          const fgcolor = chooseTextColorForBackground(bgcolor);\n          // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'string' is not assignable to par... Remove this comment to see the full error message\n          dataLabels.textfont.color.push(fgcolor);\n        }\n      }\n    }\n    // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'any[]' is not assignable to para... Remove this comment to see the full error message\n    plotlySeries.z.push(item);\n  }\n\n  if (isFinite(zMax) && options.showDataLabels) {\n    return [plotlySeries, dataLabels];\n  }\n  return [plotlySeries];\n}\n\nexport default function prepareHeatmapData(seriesList: any, options: any) {\n  let colorScheme = [];\n\n  if (!options.colorScheme) {\n    colorScheme = defaultColorScheme;\n  } else if (options.colorScheme === \"Custom...\") {\n    colorScheme = [\n      [0, options.heatMinColor],\n      [1, options.heatMaxColor],\n    ];\n  } else {\n    colorScheme = Colorscale.getScale(options.colorScheme);\n  }\n\n  const additionalOptions = {\n    colorScheme,\n    formatNumber: createNumberFormatter(options.numberFormat),\n  };\n\n  return flatten(map(seriesList, series => prepareSeries(series, options, additionalOptions)));\n}\n"],"mappings":"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"}