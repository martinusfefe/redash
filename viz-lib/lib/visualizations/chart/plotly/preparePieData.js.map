{"version":3,"file":"preparePieData.js","names":["_lodash","require","_d","_interopRequireDefault","_chooseTextColorForBackground","_ColorPalette","_utils","obj","__esModule","default","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","value","_toPropertyKey","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","getPieDimensions","series","rows","cellsInRow","Math","ceil","cellWidth","cellHeight","xPadding","yPadding","getPieHoverInfoPattern","options","hasX","test","textFormat","result","prepareSeries","additionalOptions","index","hoverInfoPattern","getValueColor","seriesOptions","extend","type","globalSeriesType","yAxis","name","xPosition","yPosition","floor","labelsValuesMap","Map","sourceData","seriesTotal","reduce","data","row","y","cleanNumber","abs","each","x","normalizeValue","xAxis","concat","has","set","get","aggregatedY","yPercent","markerColors","map","Array","from","values","textColors","c","chooseTextColorForBackground","labels","visible","hole","marker","colors","hoverinfo","text","textinfo","showDataLabels","textposition","textfont","color","direction","domain","sort","piesort","color_scheme","preparePieData","seriesList","palette","AllColorPaletteArrays","valuesColors","getDefaultColor","ColorPaletteTypes","uniqueXValues","Set","d","step","colorIndices","d3","range","round","scale","ordinal","valuesOptions","item","isString","includes","columnMapping","v"],"sources":["../../../../src/visualizations/chart/plotly/preparePieData.ts"],"sourcesContent":["import { isString, each, extend, includes, map, reduce } from \"lodash\";\nimport d3 from \"d3\";\nimport chooseTextColorForBackground from \"@/lib/chooseTextColorForBackground\";\nimport { AllColorPaletteArrays, ColorPaletteTypes } from \"@/visualizations/ColorPalette\";\n\nimport { cleanNumber, normalizeValue } from \"./utils\";\n\nexport function getPieDimensions(series: any) {\n  const rows = series.length > 2 ? 2 : 1;\n  const cellsInRow = Math.ceil(series.length / rows);\n  const cellWidth = 1 / cellsInRow;\n  const cellHeight = 1 / rows;\n  const xPadding = 0.02;\n  const yPadding = 0.1;\n\n  return { rows, cellsInRow, cellWidth, cellHeight, xPadding, yPadding };\n}\n\nfunction getPieHoverInfoPattern(options: any) {\n  const hasX = /{{\\s*@@x\\s*}}/.test(options.textFormat);\n  let result = \"text\";\n  if (!hasX) result += \"+label\";\n  return result;\n}\n\nfunction prepareSeries(series: any, options: any, additionalOptions: any) {\n  const {\n    cellWidth,\n    cellHeight,\n    xPadding,\n    yPadding,\n    cellsInRow,\n    hasX,\n    index,\n    hoverInfoPattern,\n    getValueColor,\n  } = additionalOptions;\n  const seriesOptions = extend({ type: options.globalSeriesType, yAxis: 0 }, options.seriesOptions[series.name]);\n\n  const xPosition = (index % cellsInRow) * cellWidth;\n  const yPosition = Math.floor(index / cellsInRow) * cellHeight;\n\n  const labelsValuesMap = new Map();\n\n  const sourceData = new Map();\n  const seriesTotal = reduce(\n    series.data,\n    (result, row) => {\n      const y = cleanNumber(row.y);\n      return result + Math.abs(y);\n    },\n    0\n  );\n  each(series.data, row => {\n    const x = hasX ? normalizeValue(row.x, options.xAxis.type) : `Slice ${index}`;\n    const y = cleanNumber(row.y);\n\n    if (labelsValuesMap.has(x)) {\n      labelsValuesMap.set(x, labelsValuesMap.get(x) + y);\n    } else {\n      labelsValuesMap.set(x, y);\n    }\n    const aggregatedY = labelsValuesMap.get(x);\n\n\n    sourceData.set(x, {\n      x,\n      y: aggregatedY,\n      yPercent: (aggregatedY / seriesTotal) * 100,\n      row,\n    });\n  });\n\n  const markerColors = map(Array.from(sourceData.values()), data => getValueColor(data.row.x));\n  const textColors = map(markerColors, c => chooseTextColorForBackground(c));\n\n  const labels = Array.from(labelsValuesMap.keys());\n  const values = Array.from(labelsValuesMap.values());\n\n  return {\n    visible: true,\n    values,\n    labels,\n    type: \"pie\",\n    hole: 0.4,\n    marker: {\n      colors: markerColors,\n    },\n    hoverinfo: hoverInfoPattern,\n    text: [],\n    textinfo: options.showDataLabels ? \"percent\" : \"none\",\n    textposition: \"inside\",\n    textfont: {\n      color: textColors,\n    },\n    name: seriesOptions.name || series.name,\n    direction: options.direction.type,\n    domain: {\n      x: [xPosition, xPosition + cellWidth - xPadding],\n      y: [yPosition, yPosition + cellHeight - yPadding],\n    },\n    sourceData,\n    sort: options.piesort,\n    color_scheme: options.color_scheme,\n  };\n}\n\nexport default function preparePieData(seriesList: any, options: any) {\n  // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message\n  const palette = AllColorPaletteArrays[options.color_scheme];\n  const valuesColors = {};\n  let getDefaultColor : Function;\n\n  // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message\n  if (typeof(seriesList[0]) !== 'undefined' && ColorPaletteTypes[options.color_scheme] === 'continuous') {\n    const uniqueXValues =[... new Set(seriesList[0].data.map((d: any) => d.x))];\n    const step = (palette.length - 1) / (uniqueXValues.length - 1 || 1);\n    const colorIndices = d3.range(uniqueXValues.length).map(function(i) {\n      return Math.round(step * i);\n    });\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'scale' does not exist on type 'typeof im... Remove this comment to see the full error message\n    getDefaultColor = d3.scale.ordinal()\n      .domain(uniqueXValues) // Set domain as the unique x-values\n      .range(colorIndices.map(index => palette[index]));\n  } else {\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'scale' does not exist on type 'typeof im... Remove this comment to see the full error message\n    getDefaultColor = d3.scale\n      .ordinal()\n      .domain([])\n      .range(palette);\n  };\n\n  each(options.valuesOptions, (item, key) => {\n    if (isString(item.color) && item.color !== \"\") {\n      // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message\n      valuesColors[key] = item.color;\n    }\n  });\n\n  const additionalOptions = {\n    ...getPieDimensions(seriesList),\n    hasX: includes(options.columnMapping, \"x\"),\n    hoverInfoPattern: getPieHoverInfoPattern(options),\n    // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message\n    getValueColor: (v: any) => valuesColors[v] || getDefaultColor(v),\n  };\n\n  return map(seriesList, (series, index) => prepareSeries(series, options, { ...additionalOptions, index }));\n}\n"],"mappings":"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"}